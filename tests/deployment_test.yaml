suite: deployment tests
templates:
  - charts/app-template/templates/common.yaml
tests:
  - it: should render with default values
    asserts:
      - hasDocuments:
          count: 11  # Deployments, services, PVCs, etc.
      - isKind:
          of: Deployment
        documentIndex: 0

  - it: should create main nextcloud deployment
    asserts:
      - isKind:
          of: Deployment
        documentIndex: 0
      - equal:
          path: metadata.name
          value: nextcloud-main

  - it: should create postgresql deployment
    asserts:
      - isKind:
          of: Deployment
        documentIndex: 1
      - equal:
          path: metadata.name
          value: nextcloud-postgresql

  - it: should create redis deployment
    asserts:
      - isKind:
          of: Deployment
        documentIndex: 2
      - equal:
          path: metadata.name
          value: nextcloud-redis

  - it: should set correct image for nextcloud
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: nextcloud:30.0.2-apache
        documentIndex: 0

  - it: should set fsGroup for nextcloud pod
    asserts:
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 33
        documentIndex: 0

  - it: should mount data volume
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: data
            mountPath: /var/www/html
        documentIndex: 0

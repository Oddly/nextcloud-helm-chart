# Nextcloud Helm Chart - Minimal Configuration
# For all available options, see values-reference.yaml

app-template:
  controllers:
    main:
      type: deployment
      replicas: 1
      strategy: Recreate

      pod:
        securityContext:
          fsGroup: 33
          fsGroupChangePolicy: OnRootMismatch

      containers:
        main:
          image:
            repository: nextcloud
            tag: "30.0.2-apache"

          env:
            TZ: "UTC"
            NEXTCLOUD_ADMIN_USER:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: admin-user
            NEXTCLOUD_ADMIN_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: admin-password
            NEXTCLOUD_TRUSTED_DOMAINS: "nextcloud.example.com localhost"
            POSTGRES_HOST: "nextcloud-postgresql"
            POSTGRES_DB: "nextcloud"
            POSTGRES_USER:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: postgres-user
            POSTGRES_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: postgres-password
            REDIS_HOST: "nextcloud-redis"
            REDIS_HOST_PORT: "6379"
            REDIS_HOST_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: redis-password
            PHP_MEMORY_LIMIT: "1024M"
            PHP_UPLOAD_LIMIT: "16G"
            APACHE_BODY_LIMIT: "0"
            OVERWRITEPROTOCOL: "https"
            # SMTP Configuration (uncomment to enable)
            # SMTP_HOST: "smtp.example.com"
            # SMTP_SECURE: "tls"
            # SMTP_PORT: "587"
            # SMTP_AUTHTYPE: "LOGIN"
            # SMTP_NAME: "user@example.com"
            # SMTP_PASSWORD: "password"
            # MAIL_FROM_ADDRESS: "nextcloud"
            # MAIL_DOMAIN: "example.com"

          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /status.php
                  port: 80
                  httpHeaders:
                    - name: Host
                      value: localhost
                initialDelaySeconds: 30
                periodSeconds: 30
                timeoutSeconds: 10
                failureThreshold: 5
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /status.php
                  port: 80
                  httpHeaders:
                    - name: Host
                      value: localhost
                initialDelaySeconds: 30
                periodSeconds: 15
                timeoutSeconds: 10
                failureThreshold: 5
            startup:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /status.php
                  port: 80
                  httpHeaders:
                    - name: Host
                      value: localhost
                initialDelaySeconds: 10
                periodSeconds: 10
                timeoutSeconds: 10
                failureThreshold: 30

          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi

    postgresql:
      type: deployment
      replicas: 1
      strategy: Recreate

      pod:
        securityContext:
          fsGroup: 70

      containers:
        main:
          image:
            repository: postgres
            tag: "16-alpine"

          env:
            POSTGRES_DB: nextcloud
            POSTGRES_USER:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: postgres-user
            POSTGRES_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: postgres-password
            PGDATA: /var/lib/postgresql/data/pgdata

          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                exec:
                  command: ["pg_isready", "-U", "nextcloud", "-d", "nextcloud"]
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 5
            readiness:
              enabled: true
              custom: true
              spec:
                exec:
                  command: ["pg_isready", "-U", "nextcloud", "-d", "nextcloud"]
                initialDelaySeconds: 5
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 5

          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 1Gi

    redis:
      type: deployment
      replicas: 1
      strategy: Recreate

      pod:
        securityContext:
          fsGroup: 1000

      containers:
        main:
          image:
            repository: redis
            tag: "7-alpine"

          command: ["redis-server"]
          args: ["--requirepass", "$(REDIS_PASSWORD)"]

          env:
            REDIS_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: redis-password

          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                tcpSocket:
                  port: 6379
                initialDelaySeconds: 10
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 5
            readiness:
              enabled: true
              custom: true
              spec:
                tcpSocket:
                  port: 6379
                initialDelaySeconds: 5
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 5

          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 500m
              memory: 256Mi

    cron:
      type: cronjob

      cronjob:
        schedule: "*/5 * * * *"
        concurrencyPolicy: Forbid
        successfulJobsHistory: 1
        failedJobsHistory: 1

      pod:
        securityContext:
          runAsUser: 33
          runAsGroup: 33
          fsGroup: 33

      containers:
        main:
          image:
            repository: nextcloud
            tag: "30.0.2-apache"

          securityContext:
            runAsUser: 33
            runAsGroup: 33

          command: ["php"]
          args: ["-f", "/var/www/html/cron.php"]

          env:
            POSTGRES_HOST: nextcloud-postgresql
            POSTGRES_DB: nextcloud
            POSTGRES_USER:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: postgres-user
            POSTGRES_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: postgres-password
            REDIS_HOST: nextcloud-redis
            REDIS_HOST_PORT: "6379"
            REDIS_HOST_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: redis-password

          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 1Gi

  service:
    main:
      controller: main
      ports:
        http:
          port: 80

    postgresql:
      controller: postgresql
      ports:
        postgres:
          port: 5432

    redis:
      controller: redis
      ports:
        redis:
          port: 6379

  ingress:
    main:
      enabled: true
      className: ""  # Set to "nginx" for ingress-nginx
      annotations:
        # For ingress-nginx, uncomment:
        # cert-manager.io/cluster-issuer: letsencrypt-prod
        # nginx.ingress.kubernetes.io/proxy-body-size: "16G"
        # nginx.ingress.kubernetes.io/proxy-request-buffering: "off"
      hosts:
        - host: nextcloud.example.com
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: main
                port: http
      tls: []
        # - secretName: nextcloud-tls
        #   hosts:
        #     - nextcloud.example.com

  # HTTPRoute for Gateway API (Cilium, Envoy Gateway, etc.)
  # Uncomment and configure if using Gateway API instead of Ingress
  # route:
  #   main:
  #     enabled: true
  #     parentRefs:
  #       - name: my-gateway
  #         namespace: gateway-namespace
  #         sectionName: https
  #     hostnames:
  #       - "nextcloud.example.com"
  #     rules:
  #       - backendRefs:
  #           - name: main
  #             port: 80

  # ConfigMaps for PHP/Redis session configuration
  # Uncomment to enable Redis-based sessions (required for multi-replica)
  # configMaps:
  #   php-config:
  #     enabled: true
  #     data:
  #       redis-session.ini: |
  #         session.save_handler = redis
  #         session.save_path = "tcp://nextcloud-redis:6379?auth=${REDIS_HOST_PASSWORD}"

  persistence:
    data:
      enabled: true
      type: persistentVolumeClaim
      storageClass: ""  # Uses default StorageClass if empty
      accessMode: ReadWriteOnce
      size: 100Gi
      advancedMounts:
        main:
          main:
            - path: /var/www/html
        cron:
          main:
            - path: /var/www/html

    postgresql-data:
      enabled: true
      type: persistentVolumeClaim
      storageClass: ""  # Uses default StorageClass if empty
      accessMode: ReadWriteOnce
      size: 10Gi
      advancedMounts:
        postgresql:
          main:
            - path: /var/lib/postgresql/data

    redis-data:
      enabled: true
      type: persistentVolumeClaim
      storageClass: ""  # Uses default StorageClass if empty
      accessMode: ReadWriteOnce
      size: 1Gi
      advancedMounts:
        redis:
          main:
            - path: /data

    # Uncomment to mount PHP config for Redis sessions
    # php-config:
    #   enabled: true
    #   type: configMap
    #   name: nextcloud-php-config
    #   advancedMounts:
    #     main:
    #       main:
    #         - path: /usr/local/etc/php/conf.d/redis-session.ini
    #           subPath: redis-session.ini

  serviceAccount:
    create: true
    name: nextcloud

  # ServiceMonitor for Prometheus (requires prometheus-operator)
  # serviceMonitor:
  #   main:
  #     enabled: true
  #     endpoints:
  #       - port: http
  #         path: /ocs/v2.php/apps/serverinfo/api/v1/info
  #         params:
  #           format: ["json"]
  #         interval: 60s

  # Network Policies - restrict traffic to only necessary connections
  # networkpolicies:
  #   main:
  #     enabled: true
  #     controller: main
  #     policyTypes:
  #       - Ingress
  #       - Egress
  #     rules:
  #       ingress:
  #         - from:
  #             - namespaceSelector: {}  # Allow from any namespace (ingress controller)
  #           ports:
  #             - protocol: TCP
  #               port: 80
  #       egress:
  #         - to:
  #             - podSelector:
  #                 matchLabels:
  #                   app.kubernetes.io/component: postgresql
  #           ports:
  #             - protocol: TCP
  #               port: 5432
  #         - to:
  #             - podSelector:
  #                 matchLabels:
  #                   app.kubernetes.io/component: redis
  #           ports:
  #             - protocol: TCP
  #               port: 6379
  #         - to:  # Allow DNS
  #             - namespaceSelector: {}
  #           ports:
  #             - protocol: UDP
  #               port: 53
  #         - to:  # Allow external HTTPS (for apps, updates)
  #             - ipBlock:
  #                 cidr: 0.0.0.0/0
  #           ports:
  #             - protocol: TCP
  #               port: 443

  defaultPodOptions:
    automountServiceAccountToken: false
    # Pod Disruption Budget (useful when replicas > 1)
    # podDisruptionBudget:
    #   enabled: true
    #   minAvailable: 1

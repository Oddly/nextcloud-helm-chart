# Nextcloud Helm Chart
# For all available options, see values-reference.yaml
#
# IMPORTANT: Install with release name "nextcloud":
#   helm install nextcloud . -n nextcloud
#
# Credentials are auto-generated on first install. Retrieve with:
#   kubectl get secret nextcloud-credentials -n nextcloud -o jsonpath='{.data.admin-password}' | base64 -d

# Use an existing secret instead of auto-generating
# existingSecret: "my-nextcloud-secret"

# Nextcloud configuration
nextcloud:
  adminUser: "admin"
  # adminPassword: ""  # Auto-generated if not set

# PostgreSQL configuration
postgresql:
  user: "nextcloud"
  # password: ""  # Auto-generated if not set

# Redis configuration
redis: {}
  # password: ""  # Auto-generated if not set

app-template:
  controllers:
    main:
      type: deployment
      replicas: 1
      strategy: Recreate

      pod:
        securityContext:
          fsGroup: 33
          fsGroupChangePolicy: OnRootMismatch

      initContainers:
        wait-for-postgres:
          image:
            repository: busybox
            tag: "1.36"
          command: ["sh", "-c", "until nc -z nextcloud-postgresql 5432; do echo 'Waiting for PostgreSQL...'; sleep 2; done"]

      containers:
        main:
          image:
            repository: nextcloud
            tag: "32.0.2-apache"

          env:
            TZ: "UTC"
            NEXTCLOUD_ADMIN_USER:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: admin-user
            NEXTCLOUD_ADMIN_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: admin-password
            NEXTCLOUD_TRUSTED_DOMAINS: "nextcloud.example.com localhost"
            POSTGRES_HOST: "nextcloud-postgresql"
            POSTGRES_DB: "nextcloud"
            POSTGRES_USER:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: postgres-user
            POSTGRES_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: postgres-password
            REDIS_HOST: "nextcloud-redis"
            REDIS_HOST_PORT: "6379"
            REDIS_HOST_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: redis-password
            PHP_MEMORY_LIMIT: "1024M"
            PHP_UPLOAD_LIMIT: "16G"
            APACHE_BODY_LIMIT: "0"
            OVERWRITEPROTOCOL: "https"

          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /status.php
                  port: 80
                  httpHeaders:
                    - name: Host
                      value: localhost
                initialDelaySeconds: 30
                periodSeconds: 30
                timeoutSeconds: 10
                failureThreshold: 5
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /status.php
                  port: 80
                  httpHeaders:
                    - name: Host
                      value: localhost
                initialDelaySeconds: 30
                periodSeconds: 15
                timeoutSeconds: 10
                failureThreshold: 5
            startup:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /status.php
                  port: 80
                  httpHeaders:
                    - name: Host
                      value: localhost
                initialDelaySeconds: 10
                periodSeconds: 10
                timeoutSeconds: 10
                failureThreshold: 30

          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi

    postgresql:
      type: deployment
      replicas: 1
      strategy: Recreate

      pod:
        securityContext:
          fsGroup: 70

      containers:
        main:
          image:
            repository: postgres
            tag: "16-alpine"

          env:
            POSTGRES_DB: nextcloud
            POSTGRES_USER:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: postgres-user
            POSTGRES_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: postgres-password
            PGDATA: /var/lib/postgresql/data/pgdata

          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                exec:
                  command: ["pg_isready", "-U", "nextcloud", "-d", "nextcloud"]
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 5
            readiness:
              enabled: true
              custom: true
              spec:
                exec:
                  command: ["pg_isready", "-U", "nextcloud", "-d", "nextcloud"]
                initialDelaySeconds: 5
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 5

          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 1Gi

    redis:
      type: deployment
      replicas: 1
      strategy: Recreate

      pod:
        securityContext:
          fsGroup: 1000

      containers:
        main:
          image:
            repository: redis
            tag: "7-alpine"

          command: ["redis-server"]
          args: ["--requirepass", "$(REDIS_PASSWORD)"]

          env:
            REDIS_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: redis-password

          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                tcpSocket:
                  port: 6379
                initialDelaySeconds: 10
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 5
            readiness:
              enabled: true
              custom: true
              spec:
                tcpSocket:
                  port: 6379
                initialDelaySeconds: 5
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 5

          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 500m
              memory: 256Mi

    cron:
      type: cronjob

      cronjob:
        schedule: "*/5 * * * *"
        concurrencyPolicy: Forbid
        successfulJobsHistory: 1
        failedJobsHistory: 1

      pod:
        securityContext:
          runAsUser: 33
          runAsGroup: 33
          fsGroup: 33

      containers:
        main:
          image:
            repository: nextcloud
            tag: "32.0.2-apache"

          securityContext:
            runAsUser: 33
            runAsGroup: 33

          command: ["php"]
          args: ["-f", "/var/www/html/cron.php"]

          env:
            POSTGRES_HOST: nextcloud-postgresql
            POSTGRES_DB: nextcloud
            POSTGRES_USER:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: postgres-user
            POSTGRES_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: postgres-password
            REDIS_HOST: nextcloud-redis
            REDIS_HOST_PORT: "6379"
            REDIS_HOST_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: nextcloud-credentials
                  key: redis-password

          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 1Gi

  service:
    main:
      controller: main
      ports:
        http:
          port: 80

    postgresql:
      controller: postgresql
      ports:
        postgres:
          port: 5432

    redis:
      controller: redis
      ports:
        redis:
          port: 6379

  ingress:
    main:
      enabled: false  # Disabled by default - configure as needed
      className: ""   # Set to "nginx" for ingress-nginx, "tailscale" for Tailscale, etc.
      # annotations:  # Uncomment for nginx-ingress with cert-manager
      #   cert-manager.io/cluster-issuer: letsencrypt-prod
      #   nginx.ingress.kubernetes.io/proxy-body-size: "16G"
      #   nginx.ingress.kubernetes.io/proxy-request-buffering: "off"
      hosts:
        - host: nextcloud.example.com
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: main
                port: http
      # tls:  # Uncomment for TLS with cert-manager
      #   - secretName: nextcloud-tls
      #     hosts:
      #       - nextcloud.example.com

  # HTTPRoute for Gateway API (Cilium, Envoy Gateway, etc.)
  # Uncomment and configure if using Gateway API instead of Ingress
  # route:
  #   main:
  #     enabled: true
  #     parentRefs:
  #       - name: external         # Gateway name
  #         namespace: kube-system # Gateway namespace
  #         sectionName: https     # Listener name
  #     hostnames:
  #       - "nextcloud.example.com"
  #     rules:
  #       - backendRefs:
  #           # Use full service name: <release-name>-main
  #           - name: nextcloud-main
  #             port: 80

  persistence:
    data:
      enabled: true
      type: persistentVolumeClaim
      storageClass: ""
      accessMode: ReadWriteOnce
      size: 100Gi
      advancedMounts:
        main:
          main:
            - path: /var/www/html
        cron:
          main:
            - path: /var/www/html

    postgresql-data:
      enabled: true
      type: persistentVolumeClaim
      storageClass: ""
      accessMode: ReadWriteOnce
      size: 10Gi
      advancedMounts:
        postgresql:
          main:
            - path: /var/lib/postgresql/data

    redis-data:
      enabled: true
      type: persistentVolumeClaim
      storageClass: ""
      accessMode: ReadWriteOnce
      size: 1Gi
      advancedMounts:
        redis:
          main:
            - path: /data

  serviceAccount:
    nextcloud:
      enabled: true

  defaultPodOptions:
    automountServiceAccountToken: false
